{{/* Parameters Begin */}}
{{- $containerId := .Get "id" | default (anchorize .Page.Title) }}
{{- $title := .Get "title" | default "انسخ النص المكتمل" }}
{{- $successText := .Get "successText" | default "✅ تم نسخ النص" }}
{{- $size := .Get "size" }}

{{/* Parameters End */}}

<!-- Uppy.io Dependencies -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/uppy/4.18.0/uppy.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/uppy/4.18.0/uppy.min.js"></script>
<script src="https://releases.transloadit.com/uppy/locales/v3.3.1/ar_SA.min.js"> </script>

<!-- QuillJS Dependencies for clipboard fallback -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/quill/1.3.7/quill.snow.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/quill/1.3.7/quill.min.js"></script>


<style>
::placeholder {
  color: var(--secondary);
}

::selection {
  color: var(--content);
  background: var(--tertiary);
}

.fillable-text-container {
  font-family: Arial, sans-serif;
  margin: 20px 0;
  padding: 20px;
  border: 1px solid var(--border);
  border-radius: 8px;
  background-color: var(--theme);
}

.fillable-text-content {
  line-height: 1.6;
  margin: 20px 0;
  white-space: pre-wrap;
}

.fillable-blank {
  display: inline-block;
  min-width: 120px;
  max-width: 400px;
  width: auto;
  border: 1px solid var(--secondary);
  border-radius: 4px;
  padding: 4px 8px;
  margin: 0 4px;
  background-color: var(--theme);
  color: var(--primary);
  font-family: inherit;
  font-size: inherit;
  box-sizing: border-box;
  transition: width 0.2s ease;
}

.fillable-blank:focus {
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
}

.fillable-blank.expanding {
  width: auto;
}

.fillable-textarea-blank {
  display: block;
  width: 100%;
  min-height: 60px;
  max-height: 300px;
  border: 1px solid var(--secondary);
  border-radius: 4px;
  padding: 8px 12px;
  margin: 8px 0;
  background-color: var(--theme);
  color: var(--primary);
  font-family: inherit;
  font-size: inherit;
  line-height: 1.4;
  resize: vertical;
  box-sizing: border-box;
  transition: height 0.2s ease;
  min-height: 70px;
}

.fillable-textarea-blank:focus {
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
}

.copy-button {
  padding: 10px 20px;
  font-size: 16px;
  cursor: pointer;
  background-color: #007bff;
  color: white;
  border: none;
  border-radius: 4px;
  margin: 5px;
}

.copy-button:hover {
  background-color: #0056b3;
}

.copied-message {
  color: green;
  margin-top: 10px;
  display: none;
  font-weight: bold;
}

.placeholder-text {
  color: #999;
  font-style: italic;
}

.copy-buttons-container {
  text-align: center;
  margin: 10px 0;
}

.fillable-image-blank {
  display: block;
  margin: 20px 0;
  border: 2px dashed var(--secondary);
  border-radius: 8px;
  background-color: var(--theme);
  color: var(--primary);
  transition: border-color 0.2s ease;
  position: relative;
  overflow: hidden;
  min-height: 150px;
}

.uppy-Dashboard-AddFiles-title {
  color: var(--primary);
}

.uppy-Dashboard-browse {
  color: #fbb03b;
  text-decoration: underline;
}

.fillable-image-blank.has-image {
  border-style: solid;
  border-width: 1px;
  min-height: auto;
}

.fillable-image-blank.drag-over {
  border-color: #007bff;
  background-color: #f0f8ff;
}

.image-upload-container {
  position: relative;
  width: 100%;
  min-height: 150px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  box-sizing: border-box;
}

.image-placeholder-text {
  color: #666;
  font-size: 16px;
  text-align: center;
  margin-bottom: 10px;
  pointer-events: none;
}

.image-upload-hint {
  color: #999;
  font-size: 14px;
  text-align: center;
  margin-top: 5px;
  pointer-events: none;
}

.uploaded-image {
  max-width: 100%;
  height: auto;
  border-radius: 4px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.image-controls {
  position: absolute;
  top: 10px;
  right: 10px;
  display: flex;
  gap: 5px;
  transition: opacity 0.2s ease;
}

.image-control-btn {
  background: rgba(0,0,0,0.7);
  color: white;
  border: none;
  border-radius: 4px;
  padding: 5px 8px;
  cursor: pointer;
  font-size: 16px;
  transition: background-color 0.2s ease;
}

.image-control-btn:hover {
  background: rgba(0,0,0,0.9);
}

.uppy-container {
  width: 100%;
}

.uppy-Dashboard {
  min-height: 150px !important;
}

.uppy-Dashboard-inner {
  min-height: 150px !important;
  height: auto !important;
  border: none !important;
  background: transparent !important;
  display: flex;
  align-items: center;
}

.uppy-Dashboard-innerWrap {
  flex: 1;
}

.uppy-Dashboard-dropFilesHereHint {
  font-size: 16px !important;
  color: #666 !important;
}

.uppy-Dashboard-AddFiles {
  border: none !important;
}

.image-url-input {
  display: none;
}

/* QuillJS Fallback Editor Styles */
.quill-fallback-container {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--theme);
  color: var(--content);
  border-top: 2px solid #007bff;
  box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
  z-index: 1000;
  max-height: 80vh;
  display: none;
  overflow: hidden;
}

.quill-fallback-header {
  padding: 15px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.quill-fallback-title {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
}

.quill-fallback-close {
  background: var(--tertiary);
  color: var(--content);
  border: none;
  border-radius: 4px;
  padding: 8px 12px;
  cursor: pointer;
  font-size: 14px;
}

.quill-fallback-close:hover {
  background: #545b62;
}

.quill-fallback-content {
  height: 400px;
  overflow: auto;
}

.quill-fallback-editor {
  height: 100%;
  border: none;
}

.ql-editor {
  direction: rtl;
  text-align: right;
}

.quill-fallback-instructions {
  background: #e7f3ff;
  color: var(--tertiary);
  padding: 10px 20px;
  font-size: 14px;
  border-bottom: 1px solid #bee5eb;
  text-align: center;
}

#quill-fallback-select-button {
  width: 100%;
  color: var(--secondary);
}
</style>

<div class="fillable-text-container" id="fillableContainer">
  <div class="copy-buttons-container">
    <button class="copy-button {{ $size }}" onclick="copyFilledText('top')">
      {{ $title }}
    </button>
  </div>

  <div class="fillable-text-content" id="fillableContent">
    {{ .Inner | markdownify | safeHTML }}
  </div>

  <div class="copy-buttons-container">
    <button class="copy-button {{ $size }}" onclick="copyFilledText('bottom')">
      {{ $title }}
    </button>
  </div>

  <div id="copiedMessage" class="copied-message">{{ $successText }}</div>
</div>

<!-- QuillJS Fallback Editor -->
<div id="quillFallbackContainer" class="quill-fallback-container" dir="rtl">
  <div class="quill-fallback-header">
    <h3 class="quill-fallback-title">اكتمل المنشور 🎉</h3>
    <button class="quill-fallback-close" onclick="closeFallbackEditor()">✕ إغلاق</button>
  </div>
  <div class="quill-fallback-instructions">
    <button id="quill-fallback-select-button">اضغط هنا لتحديد النص ونسخه الى منصة Mighty</button>
  </div>
  <div class="quill-fallback-content">
    <div id="quillFallbackEditor" class="quill-fallback-editor"></div>
  </div>
</div>

<script>
// Generate a unique ID for this fillable text instance
const containerId = 'fillableText_{{ $containerId }}';
document.getElementById('fillableContainer').setAttribute('data-container-id', containerId);
const now = Date.now();

// Global QuillJS editor instance for fallback
let quillFallbackEditor = null;

// Debounce function
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// Save to localStorage with debounce
const saveToLocalStorage = debounce(function(containerId, values) {
  try {
    localStorage.setItem(`fillableText_${containerId}`, JSON.stringify(values));
  } catch (e) {
    console.warn('Could not save to localStorage:', e);
  }
}, 500);

// Load from localStorage
function loadFromLocalStorage(containerId) {
  try {
    const saved = localStorage.getItem(`fillableText_${containerId}`);
    return saved ? JSON.parse(saved) : {};
  } catch (e) {
    console.warn('Could not load from localStorage:', e);
    return {};
  }
}

// Auto-resize input function
function autoResizeInput(input) {
  // Create a temporary span to measure text width
  const tempSpan = document.createElement('span');
  tempSpan.style.visibility = 'hidden';
  tempSpan.style.position = 'absolute';
  tempSpan.style.whiteSpace = 'pre';
  tempSpan.style.font = window.getComputedStyle(input).font;
  tempSpan.style.padding = window.getComputedStyle(input).padding;
  tempSpan.style.border = window.getComputedStyle(input).border;
  tempSpan.style.boxSizing = 'border-box';

  // Set the text content
  const text = input.value || input.placeholder;
  tempSpan.textContent = text;

  // Add to DOM temporarily to measure
  document.body.appendChild(tempSpan);

  // Calculate width with some padding
  const textWidth = tempSpan.offsetWidth + 20; // Add 20px for extra padding

  // Remove temporary span
  document.body.removeChild(tempSpan);

  // Set input width (with min/max constraints)
  const minWidth = 120;
  const maxWidth = 400;
  const newWidth = Math.max(minWidth, Math.min(maxWidth, textWidth));

  input.style.width = newWidth + 'px';
}

// Auto-resize textarea function
function autoResizeTextarea(textarea) {
  // Reset height to auto to get the correct scrollHeight
  textarea.style.height = 'auto';

  // Calculate new height based on content
  const minHeight = 60;
  const maxHeight = 300;
  const newHeight = Math.max(minHeight, Math.min(maxHeight, textarea.scrollHeight));

  // Set the new height
  textarea.style.height = newHeight + 'px';
}

// Process the content to replace __BLANK__:placeholder with input fields
document.addEventListener('DOMContentLoaded', function() {
  const content = document.getElementById('fillableContent');
  const text = content.innerHTML;

  // Load saved values
  const savedValues = loadFromLocalStorage(containerId);

  // Replace __BLANK__:placeholder patterns with input fields
  // Updated regex to be more robust and handle various edge cases

  let processedText = text
    .replace(/<code>__BLANK__:([^:]*):?(.*?)<\/code>/g, function(match, id, placeholder) {
      const savedValue = savedValues[id] || '';
      return `<input type="text" class="fillable-blank" id="${id}" placeholder="${placeholder.trim()}" data-original="${match}" value="${savedValue}">`;
    })
    .replace(/<code>__TEXTAREA_BLANK__:([^:]*):?(.*?)<\/code>/g, function(match, id, placeholder) {
      const savedValue = savedValues[id] || '';
      return `<textarea class="fillable-textarea-blank" id="${id}" placeholder="${placeholder.replace(/\\n/g, '\n').trim()}" data-original="${match}" value="${savedValue}"></textarea>`;
    })
    .replace(/<code>__IMAGE_BLANK__:([^:]*):?(.*?)<\/code>/g, function(match, id, placeholder) {
      const savedValue = savedValues[id] || '';
      return `<div class="fillable-image-blank ${savedValue ? 'has-image': ''}" id="${id}" data-placeholder="${placeholder.trim()}" data-original="${match}">
        <input type="hidden" class="image-url-input" value="${savedValue}">
        <div class="image-upload-container">
          ${savedValue ? `<img src="${savedValue}" alt="Uploaded Image" class="uploaded-image">
          <div class="image-controls">
            <button class="image-control-btn" onclick="removeImage('${id}')">اختار غير صورة</button>
          </div>` : `<div class="uppy-container" id="uppy-${id}"></div>`}
        </div>
      </div>`;
    });

  content.innerHTML = processedText;

  // Add event listeners to all input fields, textareas, and image blanks
  const inputs = content.querySelectorAll('.fillable-blank');
  const textareas = content.querySelectorAll('.fillable-textarea-blank');
  const imageBlanks = content.querySelectorAll('.fillable-image-blank');

  // Handle input fields
  inputs.forEach(input => {
    // Auto-expand functionality
    input.addEventListener('input', function() {
      // Auto-resize the input
      autoResizeInput(this);

      // Save to localStorage
      saveAllValues();
    });

    // Initial resize
    autoResizeInput(input);
  });

  // Handle textareas
  textareas.forEach(textarea => {
    // Auto-expand functionality
    textarea.value = savedValues[textarea.id] || '';
    textarea.addEventListener('input', function() {
      // Auto-resize the textarea
      autoResizeTextarea(this);

      // Save to localStorage
      saveAllValues();
    });

    // Initial resize
    autoResizeTextarea(textarea);
  });

  // Handle image blanks with Uppy
  imageBlanks.forEach(imageBlank => {
    const imageId = imageBlank.id;
    const placeholder = imageBlank.dataset.placeholder;
    const uppyContainer = imageBlank.querySelector(`#uppy-${imageId}`);
    const urlInput = imageBlank.querySelector('.image-url-input');

    if (uppyContainer) {
      initializeUppyForContainer(imageId, placeholder, uppyContainer, urlInput);
    }
  });

  // Function to save all values (inputs, textareas, images)
  function saveAllValues() {
    const values = {};

    // Save input values
    inputs.forEach(inp => {
      values[inp.id] = inp.value;
    });

    // Save textarea values
    textareas.forEach(textarea => {
      values[textarea.id] = textarea.value;
    });

    // Save image URLs
    imageBlanks.forEach(imageBlank => {
      const urlInput = imageBlank.querySelector('.image-url-input');
      values[imageBlank.id] = urlInput.value;
    });

    saveToLocalStorage(containerId, values);
  }
});

// Helper function to update image display
function updateImageDisplay(imageId, fileUrl) {
  const imageBlank = document.getElementById(imageId);
  const urlInput = imageBlank.querySelector('.image-url-input');
  const uploadContainer = imageBlank.querySelector('.image-upload-container');
  const uppyContainer = imageBlank.querySelector(`#uppy-${imageId}`);

  // Update hidden input value
  urlInput.value = fileUrl;

  // Update display
  uploadContainer.innerHTML = `
    <img src="${fileUrl}" alt="Uploaded Image" class="uploaded-image">
    <div class="image-controls">
      <button class="image-control-btn" onclick="removeImage('${imageId}')">اختار غير صورة</button>
    </div>
    <div class="uppy-container" id="uppy-${imageId}" style="display: none;"></div>
  `;

  // Add has-image class
  imageBlank.classList.add('has-image');
}

// Function to remove an image
function removeImage(imageId) {
  const imageBlank = document.getElementById(imageId);
  const urlInput = imageBlank.querySelector('.image-url-input');
  const uploadContainer = imageBlank.querySelector('.image-upload-container');
  const placeholder = imageBlank.dataset.placeholder;

  // Clear the URL
  urlInput.value = '';

  // Reset display to placeholder
  uploadContainer.innerHTML = `
    <div class="uppy-container" id="uppy-${imageId}"></div>
  `;

  // Remove has-image class
  imageBlank.classList.remove('has-image');

  // Reinitialize Uppy for this container
  // Note: This is a simplified reinitialization - in production you might want to reuse the same Uppy instance
  const uppyContainer = imageBlank.querySelector(`#uppy-${imageId}`);
  initializeUppyForContainer(imageId, placeholder, uppyContainer, urlInput);

  // Save changes
  const containerId = 'fillableText_{{ $containerId }}';
  const content = document.getElementById('fillableContent');
  const inputs = content.querySelectorAll('.fillable-blank');
  const textareas = content.querySelectorAll('.fillable-textarea-blank');
  const imageBlanks = content.querySelectorAll('.fillable-image-blank');

  const values = {};
  inputs.forEach(inp => { values[inp.id] = inp.value; });
  textareas.forEach(textarea => { values[textarea.id] = textarea.value; });
  imageBlanks.forEach(imgBlank => {
    const urlInp = imgBlank.querySelector('.image-url-input');
    values[imgBlank.id] = urlInp.value;
  });

  saveToLocalStorage(containerId, values);
}

// Helper function to initialize Uppy for a container (used for reinitialization)
function initializeUppyForContainer(imageId, placeholder, uppyContainer, urlInput) {
  const uppy = new Uppy.Uppy({
    locale: Uppy.locales.ar_SA,
    restrictions: {
      maxNumberOfFiles: 1,
      allowedFileTypes: ['image/*'],
      maxFileSize: 10 * 1024 * 1024, // 10MB
    },
    locale: {
      strings: {
        dropHereOr: placeholder || 'اسحب وأفلت صورة هنا أو %{browse}',
        browse: 'تصفح',
        upload: 'رفع',
        cancel: 'إلغاء',
        retry: 'إعادة المحاولة',
        removeFile: 'إزالة الملف',
        editFile: 'تحرير الملف',
      }
    },
    autoProceed: false,
  });

  uppy.use(Uppy.Dashboard, {
    target: uppyContainer,
    inline: true,
    width: '100%',
    height: 150,
    hideUploadButton: false,
    showProgressDetails: true,
    proudlyDisplayPoweredByUppy: false,
    locale: {
      pluralize: Uppy.locales.ar_SA.pluralize,
      strings: {
        ...Uppy.locales.ar_SA.strings,
        "browse": "اضغط هنا",
        "browseFiles": "اضغط هنا",
        "dropHereOr": `%{browse} حتى ${placeholder}`,
        "dropHint": `%{browse} حتى ${placeholder}`,
        "dropPasteBoth": `%{browse} حتى ${placeholder}`,
        "dropPasteFiles": `%{browse} حتى ${placeholder}`,
        "dropPasteFolders": `%{browse} حتى ${placeholder}`,
        "dropPasteImportBoth": `%{browse} حتى ${placeholder}`,
        "dropPasteImportFiles": `%{browse} حتى ${placeholder}`,
        "dropPasteImportFolders": `%{browse} حتى ${placeholder}`,
        browse: 'تصفح',
        upload: 'رفع',
        cancel: 'إلغاء',
        retry: 'إعادة المحاولة',
        removeFile: 'إزالة الملف',
        editFile: 'تحرير الملف',
      }
    },
  });

  uppy.use(Uppy.AwsS3, {
    async getUploadParameters(file) {
      try {
        const response = await fetch('https://mujtabot.com/api/upload-url', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            fileName: `${now}-${file.name}`,
            contentType: file.type,
            expiresIn: 3600
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const { uploadUrl, publicUrl: key } = await response.json();

        return {
          method: 'PUT',
          url: uploadUrl,
          fields: {},
          headers: {
            'Content-Type': file.type,
          },
          // Store key for later use
          _key: key,
        };
      } catch (error) {
        console.error('Error getting upload parameters:', error);
        throw error;
      }
    },
  });

  uppy.on('upload-success', async (file, response) => {
    try {
      // Get the key from the upload parameters we stored earlier
      const fileUrl = `https://files.mujtabot.com/uploads/${now}-${encodeURIComponent(uppy.getState().files[file.id].name)}`;

      if (!fileUrl) {
        console.error('Could not get uploaded image url from upload parameters');
        return;
      }

      updateImageDisplay(imageId, fileUrl);

      // Save to localStorage
      const containerId = 'fillableText_{{ $containerId }}';
      const content = document.getElementById('fillableContent');
      const inputs = content.querySelectorAll('.fillable-blank');
      const textareas = content.querySelectorAll('.fillable-textarea-blank');
      const imageBlanks = content.querySelectorAll('.fillable-image-blank');

      const values = {};
      inputs.forEach(inp => { values[inp.id] = inp.value; });
      textareas.forEach(textarea => { values[textarea.id] = textarea.value; });
      imageBlanks.forEach(imgBlank => {
        const urlInp = imgBlank.querySelector('.image-url-input');
        values[imgBlank.id] = urlInp.value;
      });

      saveToLocalStorage(containerId, values);

    } catch (error) {
      console.error('Error processing uploaded file:', error);
    }
  });

  uppy.on('upload-error', (file, error, response) => {
    console.error('Upload error:', error);
    alert('حدث خطأ أثناء رفع الصورة. يرجى المحاولة مرة أخرى.');
  });
}

// Initialize QuillJS editor for fallback (lazy initialization)
function initializeFallbackEditor() {
  if (quillFallbackEditor === null) {
    quillFallbackEditor = new Quill('#quillFallbackEditor', {
      theme: 'snow',
      modules: {
        toolbar: false // Disable toolbar for copying purposes
      },
      readOnly: false,
      placeholder: ''
    });

    quillFallbackEditor.format('direction', 'rtl');
    quillFallbackEditor.format('align', 'right');

    const selectButton = document.getElementById('quill-fallback-select-button');
    selectButton.addEventListener('click', function() {
      quillFallbackEditor.focus();
      quillFallbackEditor.setSelection(0, quillFallbackEditor.getLength());
    });
  }
}

// Show the QuillJS fallback editor with content
function showFallbackEditor(htmlContent, errorMessage = null) {
  // Initialize editor if not already done
  initializeFallbackEditor();

  // Set the content
  quillFallbackEditor.root.innerHTML = htmlContent;

  // Show the container
  const container = document.getElementById('quillFallbackContainer');
  container.style.display = 'block';

  // Scroll into view
  container.scrollIntoView({ behavior: 'smooth', block: 'end' });

  // Small delay to ensure the editor is visible, then select all content
  setTimeout(() => {
    quillFallbackEditor.focus();
    quillFallbackEditor.setSelection(0, quillFallbackEditor.getLength());
  }, 300);
}

// Close the fallback editor
function closeFallbackEditor() {
  const container = document.getElementById('quillFallbackContainer');
  container.style.display = 'none';
}

function copyFilledText(position) {
  const content = document.getElementById('fillableContent');
  const inputs = content.querySelectorAll('.fillable-blank');
  const textareas = content.querySelectorAll('.fillable-textarea-blank');
  const imageBlanks = content.querySelectorAll('.fillable-image-blank');

  // Create a copy of the content
  let filledText = content.innerHTML;

  // Replace input fields with their values or placeholders
  inputs.forEach(input => {
    const value = input.value.trim() || input.placeholder;
    const replacement = value ? value : input.placeholder;
    filledText = filledText.replace(input.outerHTML, replacement);
  });

  // Replace textarea fields with their values or placeholders
  textareas.forEach(textarea => {
    const value = textarea.value.trim() || textarea.placeholder;
    const replacement = (value ? value : textarea.placeholder).replace(/\n/g, '<br>');
    filledText = filledText.replace(textarea.outerHTML, replacement);
  });

  // Replace image fields with their values or placeholders
  imageBlanks.forEach(imageBlank => {
    const urlInput = imageBlank.querySelector('.image-url-input');
    const value = urlInput ? urlInput.value : '';
    const replacement = value ? `<img src="${value}" alt="Uploaded Image" style="max-width: 100%; height: auto;" />` : '[Image Placeholder]';
    filledText = filledText.replace(imageBlank.outerHTML, replacement);
  });

  const blob = new Blob([filledText], { type: "text/html" });
  const data = [new ClipboardItem({ "text/html": blob })];

  // Copy to clipboard
  showFallbackEditor(filledText);
  navigator.clipboard.write(data)
    .then(() => {
      const msg = document.getElementById("copiedMessage");
      msg.style.display = "block";

      // Hide the message after 3 seconds
      setTimeout(() => {
        msg.style.display = "none";
      }, 3000);
    })
    .catch(err => {
      console.error("Clipboard API failed, showing fallback editor:", err);
    });
}
</script>
